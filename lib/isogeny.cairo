from starkware.cairo.common.cairo_builtins import BitwiseBuiltin
from lib.fq2 import FQ2, fq2
from lib.uint384 import Uint384

struct ParamsThreeIsogenyG2:
    member x_num_1 : FQ2
    member x_num_2 : FQ2
    member x_num_3 : FQ2
    member x_num_4 : FQ2
    member x_den_1 : FQ2
    member x_den_2 : FQ2
    member x_den_3 : FQ2
    member x_den_4 : FQ2
    member y_num_1 : FQ2
    member y_num_2 : FQ2
    member y_num_3 : FQ2
    member y_num_4 : FQ2
    member y_den_1 : FQ2
    member y_den_2 : FQ2
    member y_den_3 : FQ2
    member y_den_4 : FQ2
end

func get_params_three_isogeny_g2() -> (params : ParamsThreeIsogenyG2):
    return (
        params=ParamsThreeIsogenyG2(
        x_num_1=FQ2(e0=Uint384(d0=122487436713566051823985796909984552918, d1=67485199573184427182665239752178590045, d2=7681218565647756904175376894847872389), e1=Uint384(d0=122487436713566051823985796909984552918, d1=67485199573184427182665239752178590045, d2=7681218565647756904175376894847872389)),
        x_num_2=FQ2(e0=Uint384(d0=0, d1=0, d2=0), e1=Uint384(d0=27179943219759692008582783298185447194, d1=202455598719553281547995719256535770136, d2=23043655696943270712526130684543617167)),
        x_num_3=FQ2(e0=Uint384(d0=27179943219759692008582783298185447198, d1=202455598719553281547995719256535770136, d2=23043655696943270712526130684543617167), e1=Uint384(d0=13589971609879846004291391649092723597, d1=271368982820245872505685163344151990796, d2=11521827848471635356263065342271808583)),
        x_num_4=FQ2(e0=Uint384(d0=149667379933325743832568580208170000081, d1=269940798292737708730660959008714360181, d2=30724874262591027616701507579391489556), e1=Uint384(d0=0, d1=0, d2=0)),
        x_den_1=FQ2(e0=Uint384(d0=0, d1=0, d2=0), e1=Uint384(d0=40769914829639538012874174947278170723, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751)),
        x_den_2=FQ2(e0=Uint384(d0=12, d1=0, d2=0), e1=Uint384(d0=40769914829639538012874174947278170783, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751)),
        x_den_3=FQ2(e0=Uint384(d0=313635500375121084810881640338032885757, d1=159249536114007638540741953206796900538, d2=29193015012204308844271843190429379693), e1=Uint384(d0=0, d1=0, d2=0)),
        x_den_4=FQ2(e0=Uint384(d0=0, d1=0, d2=0), e1=Uint384(d0=0, d1=0, d2=0)),
        y_num_1=FQ2(e0=Uint384(d0=335693145642762702200156386192687290118, d1=20590820487717257360856140803476022528, d2=28164468074041775315309715281108865427), e1=Uint384(d0=335693145642762702200156386192687290118, d1=20590820487717257360856140803476022528, d2=28164468074041775315309715281108865427)),
        y_num_2=FQ2(e0=Uint384(d0=0, d1=0, d2=0), e1=Uint384(d0=122487436713566051823985796909984552894, d1=67485199573184427182665239752178590045, d2=7681218565647756904175376894847872389)),
        y_num_3=FQ2(e0=Uint384(d0=27179943219759692008582783298185447196, d1=202455598719553281547995719256535770136, d2=23043655696943270712526130684543617167), e1=Uint384(d0=13589971609879846004291391649092723599, d1=271368982820245872505685163344151990796, d2=11521827848471635356263065342271808583)),
        y_num_4=FQ2(e0=Uint384(d0=104308243825510444556476184021810907920, d1=156989404161594275501210824643270833234, d2=24323858791217896863222026833684929232), e1=Uint384(d0=0, d1=0, d2=0)),
        y_den_1=FQ2(e0=Uint384(d0=40769914829639538012874174947278170363, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751), e1=Uint384(d0=40769914829639538012874174947278170363, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751)),
        y_den_2=FQ2(e0=Uint384(d0=0, d1=0, d2=0), e1=Uint384(d0=40769914829639538012874174947278170579, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751)),
        y_den_3=FQ2(e0=Uint384(d0=18, d1=0, d2=0), e1=Uint384(d0=40769914829639538012874174947278170777, d1=133542214618860690590306275168919549476, d2=34565483545414906068789196026815425751)),
        y_den_4=FQ2(e0=Uint384(d0=313635500375121084810881640338032885757, d1=159249536114007638540741953206796900538, d2=29193015012204308844271843190429379693), e1=Uint384(d0=0, d1=0, d2=0))
        ))
end

func isogenyMapG2{range_check_ptr, bitwise_ptr : BitwiseBuiltin*}(x : FQ2, y : FQ2) -> (
        x_res : FQ2, y_res : FQ2):
    let (params : ParamsThreeIsogenyG2) = get_params_three_isogeny_g2()

    let x_num : FQ2 = params.x_num_4
    let x_den : FQ2 = params.x_den_4
    let y_num : FQ2 = params.y_num_4
    let y_den : FQ2 = params.y_den_4

    let x_num = fq2.mul(x_num, x)
    let x_den = fq2.mul(x_den, x)
    let y_num = fq2.mul(y_num, x)
    let y_den = fq2.mul(y_den, x)

    let x_num = fq2.add(x_num, params.x_num_3)
    let x_den = fq2.add(x_den, params.x_den_3)
    let y_num = fq2.add(y_num, params.y_num_3)
    let y_den = fq2.add(y_den, params.y_den_3)

    let x_num = fq2.mul(x_num, x)
    let x_den = fq2.mul(x_den, x)
    let y_num = fq2.mul(y_num, x)
    let y_den = fq2.mul(y_den, x)

    let x_num = fq2.add(x_num, params.x_num_2)
    let x_den = fq2.add(x_den, params.x_den_2)
    let y_num = fq2.add(y_num, params.y_num_2)
    let y_den = fq2.add(y_den, params.y_den_2)

    let x_num = fq2.mul(x_num, x)
    let x_den = fq2.mul(x_den, x)
    let y_num = fq2.mul(y_num, x)
    let y_den = fq2.mul(y_den, x)

    let x_num = fq2.add(x_num, params.x_num_1)
    let x_den = fq2.add(x_den, params.x_den_1)
    let y_num = fq2.add(y_num, params.y_num_1)
    let y_den = fq2.add(y_den, params.y_den_1)

    let x_den = fq2.inv(x_den)
    let y_den = fq2.inv(y_den)

    let (x_num : FQ2) = fq2.mul(x_num, x_den)
    let (y_num : FQ2) = fq2.mul(y_num, y_den)

    let (y_num : FQ2) = fq2.mul(y_num, y)

    return (x_num, y_num)
end
